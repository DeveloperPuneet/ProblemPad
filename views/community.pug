doctype html
html(lang="en")
  head
    script(src="https://unpkg.com/lamejs@1.2.0/lame.min.js")
    meta(charset="UTF-8")
    meta(name="viewport", content="width=device-width, initial-scale=1.0")
    title #{community.Name} - ProblemPad
    link(rel="stylesheet", href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css")
    style.
      :root {
        --primary: #6366f1;
        --primary-dark: #4f46e5;
        --secondary: #10b981;
        --dark: #0f172a;
        --darker: #020617;
        --light: #f8fafc;
        --gray: #64748b;
        --gray-dark: #334155;
        --warning: #f59e0b;
        --error: #ef4444;
        --info: #3b82f6;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background-color: var(--darker);
        color: var(--light);
        line-height: 1.6;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .container {
        width: 100%;
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 20px;
      }

      /* Header with User Info */
      .dashboard-header {
        background-color: rgba(2, 6, 23, 0.95);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid var(--gray-dark);
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        height: 70px;
      }

      .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        height: 70px;
      }

      .logo {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--light);
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .logo i {
        color: var(--primary);
      }

      .user-menu {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        position: relative;
        cursor: pointer;
      }

      .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--primary);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: var(--light);
      }

      .user-details-popup {
        position: absolute;
        top: 100%;
        right: 0;
        background: var(--dark);
        border: 1px solid var(--gray-dark);
        border-radius: 8px;
        padding: 1.5rem;
        width: 300px;
        display: none;
        z-index: 1002;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
      }

      .user-details-popup.active {
        display: block;
      }

      .user-detail-item {
        margin-bottom: 0.75rem;
        display: flex;
        justify-content: space-between;
      }

      .user-detail-label {
        color: var(--gray);
        font-weight: 600;
      }

      .user-detail-value {
        color: var(--light);
        text-align: right;
      }

      .notification-container {
        position: relative;
      }

      .notification-bell {
        position: relative;
        background: none;
        border: none;
        color: var(--light);
        font-size: 1.25rem;
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 50%;
        transition: background 0.3s;
      }

      .notification-bell:hover {
        background: var(--gray-dark);
      }

      .notification-count {
        position: absolute;
        top: 0;
        right: 0;
        background: var(--error);
        color: white;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        font-size: 0.7rem;
        display: none;
        align-items: center;
        justify-content: center;
        font-weight: 600;
      }

      .logout-btn {
        background: var(--gray-dark);
        color: var(--light);
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.3s;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .logout-btn:hover {
        background: var(--primary);
      }

      /* Main Content */
      .community-main {
        flex: 1;
        margin-top: 70px;
        padding: 2rem 0;
      }

      .community-header {
        background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
      }

      .community-header h1 {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
      }

      .community-header p {
        opacity: 0.9;
        margin-bottom: 1rem;
      }

      .community-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-top: 1.5rem;
      }

      .stat {
        background: rgba(255, 255, 255, 0.2);
        padding: 1rem;
        border-radius: 8px;
        text-align: center;
      }

      .stat-number {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 0.25rem;
      }

      .stat-label {
        font-size: 0.9rem;
        opacity: 0.9;
      }

      /* Problems Grid by Category */
      .problems-categories {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 2rem;
        margin-bottom: 2rem;
      }

      .category-section {
        background: var(--dark);
        border: 1px solid var(--gray-dark);
        border-radius: 12px;
        padding: 1.5rem;
      }

      .category-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid var(--gray-dark);
      }

      .category-icon {
        font-size: 1.5rem;
        color: var(--primary);
      }

      .category-title {
        font-size: 1.25rem;
        font-weight: 600;
      }

      .problem-card {
        background: var(--darker);
        border: 1px solid var(--gray-dark);
        border-radius: 8px;
        padding: 1.25rem;
        margin-bottom: 1rem;
        transition: all 0.3s;
      }

      .problem-card.solved {
        border-color: var(--secondary);
        opacity: 0.8;
      }

      .problem-card.waiting-confirmation {
        border-color: var(--warning);
      }

      .problem-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.75rem;
      }

      .problem-user {
        font-weight: 600;
        color: var(--primary);
      }

      .problem-status {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
      }

      .status-pending { background: var(--warning); color: white; }
      .status-solved { background: var(--secondary); color: white; }
      .status-waiting { background: var(--info); color: white; }

      .problem-message {
        margin-bottom: 0.75rem;
        line-height: 1.5;
      }

      .problem-details {
        background: rgba(255, 255, 255, 0.05);
        padding: 0.75rem;
        border-radius: 6px;
        margin-bottom: 1rem;
      }

      .detail-item {
        margin-bottom: 0.5rem;
        display: flex;
        justify-content: space-between;
      }

      .detail-label {
        color: var(--gray);
        font-weight: 600;
      }

      .worker-remarks {
        background: rgba(59, 130, 246, 0.1);
        border-left: 3px solid var(--info);
        padding: 0.75rem;
        border-radius: 4px;
        margin-bottom: 1rem;
      }

      .worker-remarks strong {
        color: var(--info);
      }

      .problem-actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
      }

      .btn {
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        border: none;
        font-size: 0.9rem;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
      }

      .btn-primary { background: var(--primary); color: var(--light); }
      .btn-primary:hover { background: var(--primary-dark); }
      .btn-success { background: var(--secondary); color: var(--light); }
      .btn-success:hover { background: #0da271; }
      .btn-warning { background: var(--warning); color: var(--light); }
      .btn-warning:hover { background: #d97706; }
      .btn-info { background: var(--info); color: var(--light); }
      .btn-info:hover { background: #2563eb; }
      .btn-outline { 
        background: transparent; 
        border: 1px solid var(--gray-dark); 
        color: var(--light); 
      }
      .btn-outline:hover { 
        border-color: var(--primary); 
        background: rgba(99, 102, 241, 0.1); 
      }

      /* Raise Problem Section */
      .raise-problem-section {
        background: var(--dark);
        border: 1px solid var(--gray-dark);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
      }

      .section-title {
        font-size: 1.5rem;
        margin-bottom: 1.5rem;
        color: var(--light);
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
      }

      .form-group input,
      .form-group textarea,
      .form-group select {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--gray-dark);
        border-radius: 8px;
        background: var(--darker);
        color: var(--light);
        resize: vertical;
      }

      .form-group textarea {
        min-height: 100px;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
      }

      /* Members Section */
      .members-section {
        background: var(--dark);
        border: 1px solid var(--gray-dark);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
      }

      .members-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 1rem;
      }

      .member-card {
        background: var(--darker);
        border: 1px solid var(--gray-dark);
        border-radius: 8px;
        padding: 1rem;
        position: relative;
      }

      .member-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: var(--primary);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        margin: 0 auto 0.5rem;
        color: var(--light);
      }

      .member-name {
        font-weight: 600;
        margin-bottom: 0.25rem;
        text-align: center;
      }

      .member-details {
        text-align: center;
        font-size: 0.9rem;
        color: var(--gray);
      }

      .owner-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background: var(--primary);
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
      }

      /* Notification Dropdown */
      .notification-dropdown {
        position: absolute;
        top: 100%;
        right: 0;
        background: var(--dark);
        border: 1px solid var(--gray-dark);
        border-radius: 8px;
        width: 400px;
        max-height: 500px;
        overflow-y: auto;
        display: none;
        z-index: 1001;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
      }

      .notification-dropdown.active {
        display: block;
      }

      .notification-header {
        padding: 1rem;
        border-bottom: 1px solid var(--gray-dark);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .notification-list {
        max-height: 350px;
        overflow-y: auto;
      }

      .notification-item {
        padding: 1rem;
        border-bottom: 1px solid var(--gray-dark);
        display: flex;
        gap: 0.75rem;
        transition: background 0.3s;
      }

      .notification-item:hover {
        background: var(--gray-dark);
      }

      .notification-item.unread {
        background: rgba(99, 102, 241, 0.1);
      }

      .notification-icon {
        font-size: 1.25rem;
        flex-shrink: 0;
        margin-top: 0.25rem;
      }

      .notification-content {
        flex: 1;
      }

      .notification-message {
        margin-bottom: 0.5rem;
        line-height: 1.4;
      }

      .notification-time {
        font-size: 0.8rem;
        color: var(--gray);
        margin-bottom: 0.5rem;
      }

      .notification-actions {
        display: flex;
        gap: 0.5rem;
      }

      .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
      }

      /* Audio Recording Styles */
      .audio-recording-container {
        margin-top: 1rem;
      }

      .recording-controls {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
        flex-wrap: wrap;
      }

      .recording-status {
        display: none;
        align-items: center;
        gap: 15px;
        margin: 10px 0;
        padding: 10px;
        background: rgba(239, 68, 68, 0.1);
        border-radius: 8px;
      }

      .recording-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #ef4444;
        font-weight: bold;
      }

      @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
      }

      .recording-indicator i {
        animation: pulse 1s infinite;
      }

      .recording-timer {
        font-family: monospace;
        font-size: 1.2rem;
        color: #f59e0b;
        margin-left: auto;
      }

      .recording-actions {
        display: none;
        gap: 10px;
        margin-top: 10px;
      }

      /* Audio Player Styles */
      .audio-player-section {
        margin-top: 1rem;
        padding: 1rem;
        background: rgba(99, 102, 241, 0.1);
        border-radius: 8px;
      }

      .audio-player-container {
        margin-top: 10px;
      }

      /* User Info Styles */
      .user-info-container {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .user-main-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .user-name {
        font-weight: 600;
        color: var(--light);
        font-size: 1.1rem;
      }

      .user-role-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: capitalize;
      }

      .worker-badge {
        background: var(--primary);
        color: var(--light);
      }

      .user-badge {
        background: var(--gray-dark);
        color: var(--light);
      }

      .user-contact-info {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }

      .contact-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--gray);
        font-size: 0.9rem;
      }

      .contact-item i {
        width: 16px;
        color: var(--primary);
      }

      /* Footer */
      footer {
        background-color: var(--darker);
        border-top: 1px solid var(--gray-dark);
        padding: 4rem 0 2rem;
        margin-top: auto;
      }

      .footer-content {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 3rem;
        margin-bottom: 3rem;
      }

      .footer-column h3 {
        font-size: 1.2rem;
        margin-bottom: 1.5rem;
        color: var(--light);
      }

      .footer-links {
        list-style: none;
      }

      .footer-links li {
        margin-bottom: 0.8rem;
      }

      .footer-links a {
        color: var(--gray);
        text-decoration: none;
        transition: color 0.3s;
      }

      .footer-links a:hover {
        color: var(--primary);
      }

      .social-links {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
      }

      .social-links a {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--gray-dark);
        color: var(--light);
        text-decoration: none;
        transition: background 0.3s;
      }

      .social-links a:hover {
        background: var(--primary);
      }

      .footer-bottom {
        text-align: center;
        padding-top: 2rem;
        border-top: 1px solid var(--gray-dark);
        color: var(--gray);
        font-size: 0.9rem;
      }

      @media (max-width: 768px) {
        .problems-categories {
          grid-template-columns: 1fr;
        }

        .form-row {
          grid-template-columns: 1fr;
        }

        .notification-dropdown {
          width: 300px;
          right: -50px;
        }

        .recording-controls {
          flex-direction: column;
        }
        
        .recording-status {
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
        }
      }

body
  // Header
  header.dashboard-header
    .container
      .header-content
        a.logo(href="/dashboard")
          i.fas.fa-tools
          | ProblemPad
        .user-menu
          // Notifications
          .notification-container
            button.notification-bell#notificationBell
              i.fas.fa-bell
              span.notification-count#notificationCount 0
            .notification-dropdown#notificationDropdown
              .notification-header
                h3 Notifications
                button.btn.btn-outline.btn-sm#markAllRead Mark All Read
              .notification-list#notificationList
                .notification-item
                  .notification-message Loading notifications...

          // User Info with Popup
          .user-info#userInfo
            .user-avatar= user.Name.charAt(0).toUpperCase()
            .user-details
              .user-name= user.Name
              .user-role= user.role
            .user-details-popup#userDetailsPopup
              .user-detail-item
                .user-detail-label Name:
                .user-detail-value= user.Name
              .user-detail-item
                .user-detail-label Mobile:
                .user-detail-value= user.Mob_no
              .user-detail-item
                .user-detail-label Address:
                .user-detail-value= user.Address
              .user-detail-item
                .user-detail-label Role:
                .user-detail-value= user.role
              if user.Proff
                .user-detail-item
                  .user-detail-label Profession:
                  .user-detail-value= user.Proff

          a.logout-btn(href="/logout")
            i.fas.fa-sign-out-alt
            |  Logout

  // Main Content
  main.community-main
    .container
      // Community Header
      .community-header
        h1= community.Name
        p= community.Description || "Community for problem resolution"
        .community-stats
          .stat
            .stat-number= community.members.length
            .stat-label Total Members
          .stat
            .stat-number= activeIssues
            .stat-label Active Problems
          .stat
            .stat-number= problems.filter(p => p.solved && p.confirmed_solved).length
            .stat-label Solved & Confirmed
          .stat
            .stat-number= problems.filter(p => p.solved && !p.confirmed_solved).length
            .stat-label Waiting Confirmation

      // Problems by Category
      .problems-categories
        // Technical Problems
        .category-section
          .category-header
            .category-icon
              i.fas.fa-laptop-code
            .category-title Technical Problems
          if problems.filter(p => p.category === 'technical').length > 0
            each problem in problems.filter(p => p.category === 'technical')
              .problem-card(
                class=problem.confirmed_solved ? 'solved' : problem.solved ? 'waiting-confirmation' : ''
              )
                .problem-header
                  .problem-user
                    each member in memberDetails
                      if member.us_id === problem.us_id
                        .user-info-container
                          .user-main-info
                            .user-name= member.Name
                            .user-role-badge(class=member.role === 'worker' ? 'worker-badge' : 'user-badge')= member.role
                          .user-contact-info
                            .contact-item
                              i.fas.fa-phone
                              span= member.Mob_no
                            if member.Address
                              .contact-item
                                i.fas.fa-map-marker-alt
                                span= member.Address
                  .problem-status(class=problem.confirmed_solved ? 'status-solved' : problem.solved ? 'status-waiting' : 'status-pending')
                    = problem.confirmed_solved ? 'Confirmed Solved' : problem.solved ? 'Waiting Confirmation' : 'Pending'
                .problem-message= problem.msg
                .problem-details
                  .detail-item
                    .detail-label Category:
                    .detail-value= problem.category
                  if problem.remarks
                    .detail-item
                      .detail-label User Remarks:
                      .detail-value= problem.remarks
                  if problem.worker_remarks
                    .worker-remarks
                      strong Worker Remarks: 
                      | #{problem.worker_remarks}
                  // Audio Player Section
                  if problem.has_audio
                    .audio-player-section
                      strong Audio Description: 
                      button.btn.btn-sm.btn-outline(type="button" onclick=`playAudio('${problem.pb_id}')` style="margin-left: 10px;")
                        i.fas.fa-play
                        | Play Audio
                      .audio-player-container(id=`audioContainer-${problem.pb_id}` style="margin-top: 10px; display: none;")
                        audio(controls id=`audioPlayer-${problem.pb_id}` style="width: 100%;")
                          source(src=`/problem-audio/${problem.pb_id}` type="audio/webm")
                        p.small.text-muted(style="margin-top: 5px;") Click play to hear the audio description
                .problem-actions
                  if !problem.solved && (user.role === 'worker' || ((!community.settings || !community.settings.onlyWorkersCanSolve) && isOwner))
                    form(action="/mark-problem-solved", method="POST", style="display: inline;")
                      input(type="hidden", name="problemId", value=problem.pb_id)
                      input(type="hidden", name="communityId", value=community.gp_id)
                      .form-group
                        label(for=`workerRemarks-${problem.pb_id}`) Your Remarks
                        textarea(
                          id=`workerRemarks-${problem.pb_id}`,
                          name="worker_remarks",
                          placeholder="Add your solution details...",
                          required
                        )
                      button.btn.btn-success(type="submit")
                        i.fas.fa-check
                        | Mark Solved
                  else if problem.solved && !problem.confirmed_solved && problem.us_id === user.us_id
                    form(action="/confirm-solution", method="POST", style="display: inline;")
                      input(type="hidden", name="problemId", value=problem.pb_id)
                      input(type="hidden", name="communityId", value=community.gp_id)
                      button.btn.btn-info(type="submit")
                        i.fas.fa-thumbs-up
                        | Confirm Solution
          else
            .problem-card(style="text-align: center; padding: 2rem;")
              .problem-message No technical problems reported yet.

        // Electrical Problems
        .category-section
          .category-header
            .category-icon
              i.fas.fa-bolt
            .category-title Electrical Problems
          if problems.filter(p => p.category === 'electrical').length > 0
            each problem in problems.filter(p => p.category === 'electrical')
              .problem-card(
                class=problem.confirmed_solved ? 'solved' : problem.solved ? 'waiting-confirmation' : ''
              )
                .problem-header
                  .problem-user
                    each member in memberDetails
                      if member.us_id === problem.us_id
                        .user-info-container
                          .user-main-info
                            .user-name= member.Name
                            .user-role-badge(class=member.role === 'worker' ? 'worker-badge' : 'user-badge')= member.role
                          .user-contact-info
                            .contact-item
                              i.fas.fa-phone
                              span= member.Mob_no
                            if member.Address
                              .contact-item
                                i.fas.fa-map-marker-alt
                                span= member.Address
                  .problem-status(class=problem.confirmed_solved ? 'status-solved' : problem.solved ? 'status-waiting' : 'status-pending')
                    = problem.confirmed_solved ? 'Confirmed Solved' : problem.solved ? 'Waiting Confirmation' : 'Pending'
                .problem-message= problem.msg
                .problem-details
                  .detail-item
                    .detail-label Category:
                    .detail-value= problem.category
                  if problem.remarks
                    .detail-item
                      .detail-label User Remarks:
                      .detail-value= problem.remarks
                  if problem.worker_remarks
                    .worker-remarks
                      strong Worker Remarks: 
                      | #{problem.worker_remarks}
                  // Audio Player Section
                  if problem.has_audio
                    .audio-player-section
                      strong Audio Description: 
                      button.btn.btn-sm.btn-outline(type="button" onclick=`playAudio('${problem.pb_id}')` style="margin-left: 10px;")
                        i.fas.fa-play
                        | Play Audio
                      .audio-player-container(id=`audioContainer-${problem.pb_id}` style="margin-top: 10px; display: none;")
                        audio(controls id=`audioPlayer-${problem.pb_id}` style="width: 100%;")
                          source(src=`/problem-audio/${problem.pb_id}` type="audio/webm")
                        p.small.text-muted(style="margin-top: 5px;") Click play to hear the audio description
                .problem-actions
                  if !problem.solved && (user.role === 'worker' || ((!community.settings || !community.settings.onlyWorkersCanSolve) && isOwner))
                    form(action="/mark-problem-solved", method="POST", style="display: inline;")
                      input(type="hidden", name="problemId", value=problem.pb_id)
                      input(type="hidden", name="communityId", value=community.gp_id)
                      .form-group
                        label(for=`workerRemarks-${problem.pb_id}`) Your Remarks
                        textarea(
                          id=`workerRemarks-${problem.pb_id}`,
                          name="worker_remarks",
                          placeholder="Add your solution details...",
                          required
                        )
                      button.btn.btn-success(type="submit")
                        i.fas.fa-check
                        | Mark Solved
                  else if problem.solved && !problem.confirmed_solved && problem.us_id === user.us_id
                    form(action="/confirm-solution", method="POST", style="display: inline;")
                      input(type="hidden", name="problemId", value=problem.pb_id)
                      input(type="hidden", name="communityId", value=community.gp_id)
                      button.btn.btn-info(type="submit")
                        i.fas.fa-thumbs-up
                        | Confirm Solution
          else
            .problem-card(style="text-align: center; padding: 2rem;")
              .problem-message No electrical problems reported yet.

        // Plumbing Problems
        .category-section
          .category-header
            .category-icon
              i.fas.fa-tint
            .category-title Plumbing Problems
          if problems.filter(p => p.category === 'plumbing').length > 0
            each problem in problems.filter(p => p.category === 'plumbing')
              .problem-card(
                class=problem.confirmed_solved ? 'solved' : problem.solved ? 'waiting-confirmation' : ''
              )
                .problem-header
                  .problem-user
                    each member in memberDetails
                      if member.us_id === problem.us_id
                        .user-info-container
                          .user-main-info
                            .user-name= member.Name
                            .user-role-badge(class=member.role === 'worker' ? 'worker-badge' : 'user-badge')= member.role
                          .user-contact-info
                            .contact-item
                              i.fas.fa-phone
                              span= member.Mob_no
                            if member.Address
                              .contact-item
                                i.fas.fa-map-marker-alt
                                span= member.Address
                  .problem-status(class=problem.confirmed_solved ? 'status-solved' : problem.solved ? 'status-waiting' : 'status-pending')
                    = problem.confirmed_solved ? 'Confirmed Solved' : problem.solved ? 'Waiting Confirmation' : 'Pending'
                .problem-message= problem.msg
                .problem-details
                  .detail-item
                    .detail-label Category:
                    .detail-value= problem.category
                  if problem.remarks
                    .detail-item
                      .detail-label User Remarks:
                      .detail-value= problem.remarks
                  if problem.worker_remarks
                    .worker-remarks
                      strong Worker Remarks: 
                      | #{problem.worker_remarks}
                  // Audio Player Section
                  if problem.has_audio
                    .audio-player-section
                      strong Audio Description: 
                      button.btn.btn-sm.btn-outline(type="button" onclick=`playAudio('${problem.pb_id}')` style="margin-left: 10px;")
                        i.fas.fa-play
                        | Play Audio
                      .audio-player-container(id=`audioContainer-${problem.pb_id}` style="margin-top: 10px; display: none;")
                        audio(controls id=`audioPlayer-${problem.pb_id}` style="width: 100%;")
                          source(src=`/problem-audio/${problem.pb_id}` type="audio/webm")
                        p.small.text-muted(style="margin-top: 5px;") Click play to hear the audio description
                .problem-actions
                  if !problem.solved && (user.role === 'worker' || ((!community.settings || !community.settings.onlyWorkersCanSolve) && isOwner))
                    form(action="/mark-problem-solved", method="POST", style="display: inline;")
                      input(type="hidden", name="problemId", value=problem.pb_id)
                      input(type="hidden", name="communityId", value=community.gp_id)
                      .form-group
                        label(for=`workerRemarks-${problem.pb_id}`) Your Remarks
                        textarea(
                          id=`workerRemarks-${problem.pb_id}`,
                          name="worker_remarks",
                          placeholder="Add your solution details...",
                          required
                        )
                      button.btn.btn-success(type="submit")
                        i.fas.fa-check
                        | Mark Solved
                  else if problem.solved && !problem.confirmed_solved && problem.us_id === user.us_id
                    form(action="/confirm-solution", method="POST", style="display: inline;")
                      input(type="hidden", name="problemId", value=problem.pb_id)
                      input(type="hidden", name="communityId", value=community.gp_id)
                      button.btn.btn-info(type="submit")
                        i.fas.fa-thumbs-up
                        | Confirm Solution
          else
            .problem-card(style="text-align: center; padding: 2rem;")
              .problem-message No plumbing problems reported yet.

        // Other Problems
        .category-section
          .category-header
            .category-icon
              i.fas.fa-tools
            .category-title Other Problems
          if problems.filter(p => p.category === 'other').length > 0
            each problem in problems.filter(p => p.category === 'other')
              .problem-card(
                class=problem.confirmed_solved ? 'solved' : problem.solved ? 'waiting-confirmation' : ''
              )
                .problem-header
                  .problem-user
                    each member in memberDetails
                      if member.us_id === problem.us_id
                        .user-info-container
                          .user-main-info
                            .user-name= member.Name
                            .user-role-badge(class=member.role === 'worker' ? 'worker-badge' : 'user-badge')= member.role
                          .user-contact-info
                            .contact-item
                              i.fas.fa-phone
                              span= member.Mob_no
                            if member.Address
                              .contact-item
                                i.fas.fa-map-marker-alt
                                span= member.Address
                  .problem-status(class=problem.confirmed_solved ? 'status-solved' : problem.solved ? 'status-waiting' : 'status-pending')
                    = problem.confirmed_solved ? 'Confirmed Solved' : problem.solved ? 'Waiting Confirmation' : 'Pending'
                .problem-message= problem.msg
                .problem-details
                  .detail-item
                    .detail-label Category:
                    .detail-value= problem.category
                  if problem.remarks
                    .detail-item
                      .detail-label User Remarks:
                      .detail-value= problem.remarks
                  if problem.worker_remarks
                    .worker-remarks
                      strong Worker Remarks: 
                      | #{problem.worker_remarks}
                  // Audio Player Section
                  if problem.has_audio
                    .audio-player-section
                      strong Audio Description: 
                      button.btn.btn-sm.btn-outline(type="button" onclick=`playAudio('${problem.pb_id}')` style="margin-left: 10px;")
                        i.fas.fa-play
                        | Play Audio
                      .audio-player-container(id=`audioContainer-${problem.pb_id}` style="margin-top: 10px; display: none;")
                        audio(controls id=`audioPlayer-${problem.pb_id}` style="width: 100%;")
                          source(src=`/problem-audio/${problem.pb_id}` type="audio/webm")
                        p.small.text-muted(style="margin-top: 5px;") Click play to hear the audio description
                .problem-actions
                  if !problem.solved && (user.role === 'worker' || ((!community.settings || !community.settings.onlyWorkersCanSolve) && isOwner))
                    form(action="/mark-problem-solved", method="POST", style="display: inline;")
                      input(type="hidden", name="problemId", value=problem.pb_id)
                      input(type="hidden", name="communityId", value=community.gp_id)
                      .form-group
                        label(for=`workerRemarks-${problem.pb_id}`) Your Remarks
                        textarea(
                          id=`workerRemarks-${problem.pb_id}`,
                          name="worker_remarks",
                          placeholder="Add your solution details...",
                          required
                        )
                      button.btn.btn-success(type="submit")
                        i.fas.fa-check
                        | Mark Solved
                  else if problem.solved && !problem.confirmed_solved && problem.us_id === user.us_id
                    form(action="/confirm-solution", method="POST", style="display: inline;")
                      input(type="hidden", name="problemId", value=problem.pb_id)
                      input(type="hidden", name="communityId", value=community.gp_id)
                      button.btn.btn-info(type="submit")
                        i.fas.fa-thumbs-up
                        | Confirm Solution
          else
            .problem-card(style="text-align: center; padding: 2rem;")
              .problem-message No other problems reported yet.

        // Carpentry Problems
        .category-section
          .category-header
            .category-icon
              i.fas.fa-hammer
            .category-title Carpentry Problems
          if problems.filter(p => p.category === 'carpentry').length > 0
            each problem in problems.filter(p => p.category === 'carpentry')
              .problem-card(
                class=problem.confirmed_solved ? 'solved' : problem.solved ? 'waiting-confirmation' : ''
              )
                .problem-header
                  .problem-user
                    each member in memberDetails
                      if member.us_id === problem.us_id
                        .user-info-container
                          .user-main-info
                            .user-name= member.Name
                            .user-role-badge(class=member.role === 'worker' ? 'worker-badge' : 'user-badge')= member.role
                          .user-contact-info
                            .contact-item
                              i.fas.fa-phone
                              span= member.Mob_no
                            if member.Address
                              .contact-item
                                i.fas.fa-map-marker-alt
                                span= member.Address
                  .problem-status(class=problem.confirmed_solved ? 'status-solved' : problem.solved ? 'status-waiting' : 'status-pending')
                    = problem.confirmed_solved ? 'Confirmed Solved' : problem.solved ? 'Waiting Confirmation' : 'Pending'
                .problem-message= problem.msg
                .problem-details
                  .detail-item
                    .detail-label Category:
                    .detail-value= problem.category
                  if problem.remarks
                    .detail-item
                      .detail-label User Remarks:
                      .detail-value= problem.remarks
                  if problem.worker_remarks
                    .worker-remarks
                      strong Worker Remarks: 
                      | #{problem.worker_remarks}
                  // Audio Player Section
                  if problem.has_audio
                    .audio-player-section
                      strong Audio Description: 
                      button.btn.btn-sm.btn-outline(type="button" onclick=`playAudio('${problem.pb_id}')` style="margin-left: 10px;")
                        i.fas.fa-play
                        | Play Audio
                      .audio-player-container(id=`audioContainer-${problem.pb_id}` style="margin-top: 10px; display: none;")
                        audio(controls id=`audioPlayer-${problem.pb_id}` style="width: 100%;")
                          source(src=`/problem-audio/${problem.pb_id}` type="audio/webm")
                        p.small.text-muted(style="margin-top: 5px;") Click play to hear the audio description
                .problem-actions
                  if !problem.solved && (user.role === 'worker' || ((!community.settings || !community.settings.onlyWorkersCanSolve) && isOwner))
                    form(action="/mark-problem-solved", method="POST", style="display: inline;")
                      input(type="hidden", name="problemId", value=problem.pb_id)
                      input(type="hidden", name="communityId", value=community.gp_id)
                      .form-group
                        label(for=`workerRemarks-${problem.pb_id}`) Your Remarks
                        textarea(
                          id=`workerRemarks-${problem.pb_id}`,
                          name="worker_remarks",
                          placeholder="Add your solution details...",
                          required
                        )
                      button.btn.btn-success(type="submit")
                        i.fas.fa-check
                        | Mark Solved
                  else if problem.solved && !problem.confirmed_solved && problem.us_id === user.us_id
                    form(action="/confirm-solution", method="POST", style="display: inline;")
                      input(type="hidden", name="problemId", value=problem.pb_id)
                      input(type="hidden", name="communityId", value=community.gp_id)
                      button.btn.btn-info(type="submit")
                        i.fas.fa-thumbs-up
                        | Confirm Solution
          else
            .problem-card(style="text-align: center; padding: 2rem;")
              .problem-message No carpentry problems reported yet.

        // Cleaning Problems
        .category-section
          .category-header
            .category-icon
              i.fas.fa-broom
            .category-title Cleaning Problems
          if problems.filter(p => p.category === 'cleaning').length > 0
            each problem in problems.filter(p => p.category === 'cleaning')
              .problem-card(
                class=problem.confirmed_solved ? 'solved' : problem.solved ? 'waiting-confirmation' : ''
              )
                .problem-header
                  .problem-user
                    each member in memberDetails
                      if member.us_id === problem.us_id
                        .user-info-container
                          .user-main-info
                            .user-name= member.Name
                            .user-role-badge(class=member.role === 'worker' ? 'worker-badge' : 'user-badge')= member.role
                          .user-contact-info
                            .contact-item
                              i.fas.fa-phone
                              span= member.Mob_no
                            if member.Address
                              .contact-item
                                i.fas.fa-map-marker-alt
                                span= member.Address
                  .problem-status(class=problem.confirmed_solved ? 'status-solved' : problem.solved ? 'status-waiting' : 'status-pending')
                    = problem.confirmed_solved ? 'Confirmed Solved' : problem.solved ? 'Waiting Confirmation' : 'Pending'
                .problem-message= problem.msg
                .problem-details
                  .detail-item
                    .detail-label Category:
                    .detail-value= problem.category
                  if problem.remarks
                    .detail-item
                      .detail-label User Remarks:
                      .detail-value= problem.remarks
                  if problem.worker_remarks
                    .worker-remarks
                      strong Worker Remarks: 
                      | #{problem.worker_remarks}
                  // Audio Player Section
                  if problem.has_audio
                    .audio-player-section
                      strong Audio Description: 
                      button.btn.btn-sm.btn-outline(type="button" onclick=`playAudio('${problem.pb_id}')` style="margin-left: 10px;")
                        i.fas.fa-play
                        | Play Audio
                      .audio-player-container(id=`audioContainer-${problem.pb_id}` style="margin-top: 10px; display: none;")
                        audio(controls id=`audioPlayer-${problem.pb_id}` style="width: 100%;")
                          source(src=`/problem-audio/${problem.pb_id}` type="audio/webm")
                        p.small.text-muted(style="margin-top: 5px;") Click play to hear the audio description
                .problem-actions
                  if !problem.solved && (user.role === 'worker' || ((!community.settings || !community.settings.onlyWorkersCanSolve) && isOwner))
                    form(action="/mark-problem-solved", method="POST", style="display: inline;")
                      input(type="hidden", name="problemId", value=problem.pb_id)
                      input(type="hidden", name="communityId", value=community.gp_id)
                      .form-group
                        label(for=`workerRemarks-${problem.pb_id}`) Your Remarks
                        textarea(
                          id=`workerRemarks-${problem.pb_id}`,
                          name="worker_remarks",
                          placeholder="Add your solution details...",
                          required
                        )
                      button.btn.btn-success(type="submit")
                        i.fas.fa-check
                        | Mark Solved
                  else if problem.solved && !problem.confirmed_solved && problem.us_id === user.us_id
                    form(action="/confirm-solution", method="POST", style="display: inline;")
                      input(type="hidden", name="problemId", value=problem.pb_id)
                      input(type="hidden", name="communityId", value=community.gp_id)
                      button.btn.btn-info(type="submit")
                        i.fas.fa-thumbs-up
                        | Confirm Solution
          else
            .problem-card(style="text-align: center; padding: 2rem;")
              .problem-message No cleaning problems reported yet.

      // Raise Problem Section with Audio Recording
      .raise-problem-section
        .section-title Raise New Problem
        form#raiseProblemForm(data-community-id=community.gp_id)
          .form-row
            .form-group
              label(for="category") Problem Category *
              select(id="category", name="category", required)
                option(value="") Select a category
                option(value="technical") Technical (Computers, Phones, Internet)
                option(value="electrical") Electrical (Wiring, Appliances, Power)
                option(value="plumbing") Plumbing (Pipes, Water, Drainage)
                option(value="carpentry") Carpentry (Furniture, Woodwork)
                option(value="cleaning") Cleaning Services
                option(value="other") Other
          .form-group
            label(for="msg") Problem Description *
            textarea(
              id="msg", 
              name="msg", 
              placeholder="Describe your problem in detail. Include specific issues, error messages, or what you need help with...", 
              required
            )
          .form-group
            label(for="remarks") Additional Remarks (Optional)
            textarea(
              id="remarks", 
              name="remarks", 
              placeholder="Any additional information, location details, preferred time for service, etc..."
            )
          
          // Audio Recording Section
          .form-group
            label Audio Recording (Optional)
            .audio-recording-container
              .recording-controls
                button.btn.btn-outline#startRecording(type="button")
                  i.fas.fa-microphone
                  | Start Recording
                button.btn.btn-outline#stopRecording(type="button" style="display: none;")
                  i.fas.fa-stop
                  | Stop Recording
                button.btn.btn-outline#cancelRecording(type="button" style="display: none;")
                  i.fas.fa-times
                  | Cancel
              .recording-status#recordingStatus
                .recording-indicator
                  i.fas.fa-circle
                  span Recording...
                .recording-timer#recordingTimer 00:00
              audio#audioPreview(controls style="display: none; margin-top: 10px; width: 100%;")
              .recording-actions#recordingActions
                button.btn.btn-success#saveRecording(type="button")
                  i.fas.fa-save
                  | Save Recording
                button.btn.btn-outline#discardRecording(type="button")
                  i.fas.fa-trash
                  | Discard
              
              // Hidden inputs to store audio data
              input(type="hidden" id="audioData" name="audio_data")
              input(type="hidden" id="audioMimeType" name="audio_mimeType")
          
          button.btn.btn-primary(type="submit")
            i.fas.fa-paper-plane
            | Submit Problem

      // Members Section
      .members-section
        .section-title Community Members
        .members-grid
          each member, index in memberDetails
            .member-card
              if index === 0
                .owner-badge(title="Community Owner")
                  i.fas.fa-crown
              .member-avatar= member.Name.charAt(0).toUpperCase()
              .member-name= member.Name
              .member-details
                div= member.role
                if member.Proff
                  div= member.Proff
                div  #{member.Mob_no}
                if member.Address
                  div  #{member.Address}
                // Owner controls: kick member (hide for owner)
                if isOwner && member.us_id !== community.members[0]
                  .member-actions(style="margin-top: 0.75rem;")
                    button.btn.btn-warning(type="button" onclick=`kickMember('${member.us_id}')`)
                      i.fas.fa-user-times 
                      | Kick member
                // Allow the currently logged-in user to leave (if not owner)
                if member.us_id === user.us_id && community.members[0] !== user.us_id
                  .member-actions(style="margin-top: 0.75rem;")
                    button.btn.btn-warning(type="button" onclick='leaveCommunity()')
                      i.fas.fa-sign-out-alt
                      | Leave Community
      
      // Invite Members Section
      if isOwner
        .members-section(style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(16, 185, 129, 0.1)); border: 1px solid var(--primary);")
          .section-title Invite New Members
          .form-group
            label(for="inviteMobileNumber") Mobile Number *
            input(
              type="tel",
              id="inviteMobileNumber",
              placeholder="Enter mobile number to invite (e.g., 9876543210)",
              title="Please enter a valid mobile number"
            )
          button.btn.btn-primary#inviteBtn(type="button" onclick="inviteMember()")
            i.fas.fa-paper-plane
            | Send Invitation
          #inviteMessage(style="margin-top: 1rem; padding: 1rem; border-radius: 8px; display: none;")

        // Community Settings (Owner)
        .members-section(style="margin-top: 1rem; border: 1px solid var(--gray-dark);")
          .section-title Community Settings
          form(action=`/com/${community.gp_id}/settings`, method="POST")
            .form-group
              label
                input(type="checkbox", name="isPublic", value="true", checked=community.isPublic)
                |  Public - Anyone can discover the community
            .form-group
              label
                input(type="checkbox", name="allowPublicJoin", value="true", checked=(community.settings && community.settings.allowPublicJoin))
                |  Allow public to join without invite
            .form-group
              label
                input(type="checkbox", name="onlyWorkersCanSolve", value="true", checked=(community.settings && community.settings.onlyWorkersCanSolve))
                |  Only workers can mark problems as solved
            button.btn.btn-primary(type="submit")
              i.fas.fa-save
              | Save Settings
            // Danger: Delete Community
            if isOwner
              button.btn.btn-danger(type="button" style="margin-left:10px;" onclick="deleteCommunity()")
                i.fas.fa-trash
                | Delete Community
      
      // Plumber Panel - Show problems related to plumbing
      if memberDetails.some(m => m.Proff && m.Proff.toLowerCase().includes('plumber'))
        .category-section
          .category-header
            .category-icon
              i.fas.fa-pipe
            .category-title Plumber - Available Services
          if memberDetails.filter(m => m.Proff && m.Proff.toLowerCase().includes('plumber')).length > 0
            each member in memberDetails.filter(m => m.Proff && m.Proff.toLowerCase().includes('plumber'))
              .member-card(style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(10, 162, 113, 0.1));")
                .member-avatar(style="background: var(--secondary);")= member.Name.charAt(0).toUpperCase()
                .member-name= member.Name
                .member-details
                  div
                    strong Plumber
                  div  #{member.Mob_no}
                  if member.Address
                    div  #{member.Address}
          else
            .problem-card(style="text-align: center; padding: 2rem;")
              .problem-message No plumbers available in this community yet.
      
      // Carpentry Panel - Show problems related to carpentry  
      if memberDetails.some(m => m.Proff && m.Proff.toLowerCase().includes('carpenter'))
        .category-section
          .category-header
            .category-icon
              i.fas.fa-hammer
            .category-title Carpenter - Available Services
          if memberDetails.filter(m => m.Proff && m.Proff.toLowerCase().includes('carpenter')).length > 0
            each member in memberDetails.filter(m => m.Proff && m.Proff.toLowerCase().includes('carpenter'))
              .member-card(style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(217, 119, 6, 0.1));")
                .member-avatar(style="background: var(--warning);")= member.Name.charAt(0).toUpperCase()
                .member-name= member.Name
                .member-details
                  div
                    strong Carpenter
                  div  #{member.Mob_no}
                  if member.Address
                    div  #{member.Address}
          else
            .problem-card(style="text-align: center; padding: 2rem;")
              .problem-message No carpenters available in this community yet.

  // Footer
  footer
    .container
      .footer-content
        .footer-column
          h3 ProblemPad
          p A platform connecting service professionals with users to resolve complaints efficiently.
          .social-links
            a(href="https://github.com/DeveloperPuneet", target="_blank")
              i.fab.fa-github
        .footer-column
          h3 Quick Links
          ul.footer-links
            li
              a(href="/") Home
            li
              a(href="/about") About Us
            li
              a(href="/contact") Contact
            li
              a(href="/term-and-conditions") Terms & Conditions
        .footer-column
          h3 Account
          ul.footer-links
            li
              a(href="/login") Login
            li
              a(href="/create-account") Create Account
            li
              a(href="/forgot-pin") Forgot Password
        .footer-column
          h3 Contact Info
          ul.footer-links
            li
              i.fas.fa-envelope
              |  developerpuneet2010@gmail.com
            li
              i.fas.fa-map-marker-alt
              |  Punjab, India
      .footer-bottom
        p &copy; 2025 ProblemPad. All rights reserved. | Designed with  for better problem solving

  // Invite Member Functions - Global Scope
  script.
    // Invite Member Function
    function inviteMember() {
      const mobileInput = document.getElementById('inviteMobileNumber');
      const mobileNumber = mobileInput.value.trim();
      const messageDiv = document.getElementById('inviteMessage');
      const communityId = '#{community.gp_id}';
      
      if (!mobileNumber) {
        showMessage(messageDiv, 'Please enter a mobile number', 'error');
        return;
      }
      
      // Check if mobile number is valid (at least 10 digits or more, numbers only)
      if (!/^\d{10,}$/.test(mobileNumber.replace(/[-\s]/g, ''))) {
        showMessage(messageDiv, 'Please enter a valid mobile number (10+ digits)', 'error');
        return;
      }
      
      try {
        console.log('Inviting member with mobile:', mobileNumber, 'to community:', communityId);
        
        fetch(`/com/${communityId}/invite`, {
          method: 'POST',
          credentials: 'same-origin',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ mobileNumber: mobileNumber })
        })
        .then(response => response.json())
        .then(result => {
          console.log('Result:', result);
          
          if (result.success) {
            showMessage(messageDiv, ' Invitation sent successfully!', 'success');
            mobileInput.value = '';
            setTimeout(() => {
              messageDiv.style.display = 'none';
            }, 4000);
          } else {
            showMessage(messageDiv, ' ' + (result.error || 'Failed to send invitation'), 'error');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showMessage(messageDiv, ' Error sending invitation. Please try again.', 'error');
        });
      } catch (error) {
        console.error('Error:', error);
        showMessage(messageDiv, ' Error sending invitation. Please try again.', 'error');
      }
    }

    // Helper function to display messages
    function showMessage(element, message, type) {
      element.textContent = message;
      element.style.display = 'block';
      element.style.background = type === 'success' 
        ? 'rgba(16, 185, 129, 0.2)' 
        : 'rgba(239, 68, 68, 0.2)';
      element.style.borderLeft = type === 'success'
        ? '3px solid var(--secondary)'
        : '3px solid var(--error)';
      element.style.color = type === 'success'
        ? 'var(--secondary)'
        : 'var(--error)';
      element.style.padding = '1rem';
      element.style.borderRadius = '8px';
      element.style.marginTop = '1rem';
    }

    // Allow Enter key to submit invitation
    document.addEventListener('DOMContentLoaded', function() {
      const mobileInput = document.getElementById('inviteMobileNumber');
      if (mobileInput) {
        mobileInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            inviteMember();
          }
        });
      }
    });

    // Kick member function (owner only)
    function kickMember(memberUsId) {
      const communityId = '#{community.gp_id}';
      if (!confirm('Are you sure you want to remove this member from the community?')) return;

      fetch(`/com/${communityId}/kick`, {
        method: 'POST',
        credentials: 'same-origin',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ memberUsId: memberUsId })
      })
      .then(r => r.json())
      .then(result => {
        if (result.success) {
          alert('Member removed successfully');
          window.location.reload();
        } else {
          alert('Error: ' + (result.error || 'Failed to remove member'));
        }
      }).catch(err => {
        console.error(err);
        alert('Failed to remove member');
      });
    }

    // Delete community function (owner only)
    function deleteCommunity() {
      const communityId = '#{community.gp_id}';
      if (!confirm('This will permanently delete the community and all its problems. Continue?')) return;

      fetch(`/com/${communityId}/delete`, {
        method: 'POST',
        credentials: 'same-origin',
        headers: { 'Content-Type': 'application/json' }
      })
      .then(r => r.json())
      .then(result => {
        if (result.success) {
          alert('Community deleted');
          window.location.href = '/dashboard';
        } else {
          alert('Error: ' + (result.error || 'Failed to delete community'));
        }
      }).catch(err => {
        console.error(err);
        alert('Failed to delete community');
      });
    }

    // Leave community (non-owner)
    function leaveCommunity() {
      const communityId = '#{community.gp_id}';
      console.log(communityId)
      if (!confirm('Are you sure you want to leave this community?')) return;

      fetch(`/com/${communityId}/leave`, {
        method: 'POST',
        credentials: 'same-origin',
        headers: { 'Content-Type': 'application/json' }
      })
      .then(async (r) => {
        const ct = r.headers.get('content-type') || '';
        if (!r.ok) {
          const text = await r.text();
          throw new Error(`Server ${r.status}: ${text}`);
        }
        // If server returned HTML (redirect to login/home), surface as error
        if (!ct.includes('application/json')) {
          const text = await r.text();
          throw new Error(`Expected JSON but received: ${text}`);
        }
        return r.json();
      })
      .then(result => {
        if (result && result.success) {
          alert('You have left the community');
          window.location.href = '/dashboard';
        } else {
          alert('Error: ' + (result && result.error ? result.error : 'Failed to leave'));
        }
      }).catch(err => {
        console.error('Leave error:', err);
        alert('Failed to leave community: ' + (err.message || err));
      });
    }



  script.
    // User Details Popup
    document.getElementById('userInfo').addEventListener('click', function(e) {
      e.stopPropagation();
      document.getElementById('userDetailsPopup').classList.toggle('active');
    });

    // Close popup when clicking outside
    document.addEventListener('click', function() {
      document.getElementById('userDetailsPopup').classList.remove('active');
    });

    // Notification System
    let notifications = [];

    async function loadNotifications() {
      try {
        const response = await fetch('/notifications', { credentials: 'same-origin' });
        notifications = await response.json();
        updateNotificationUI();
      } catch (error) {
        console.error('Failed to load notifications:', error);
      }
    }

    function updateNotificationUI() {
      const notificationCount = document.getElementById('notificationCount');
      const notificationList = document.getElementById('notificationList');
      const unreadCount = notifications.filter(n => !n.read).length;

      notificationCount.textContent = unreadCount;
      notificationCount.style.display = unreadCount > 0 ? 'flex' : 'none';

      if (notifications.length === 0) {
        notificationList.innerHTML = '<div class="notification-item"><div class="notification-message">No notifications</div></div>';
      } else {
        notificationList.innerHTML = notifications.slice(0, 5).map(notification => `
          <div class="notification-item ${notification.read ? '' : 'unread'}" data-id="${notification.id}">
            <div class="notification-icon">
              ${getNotificationIcon(notification.type)}
            </div>
            <div class="notification-content">
              <div class="notification-message">${notification.message}</div>
              <div class="notification-time">${formatTime(notification.timestamp)}</div>
              <div class="notification-actions">
                ${!notification.read ? `<button class="btn btn-sm btn-outline mark-read" onclick="markNotificationRead('${notification.id}')">Mark Read</button>` : ''}
                ${notification.type === 'invitation' ? `<button class="btn btn-sm btn-primary" onclick="acceptInvitation('${notification.communityId}')">Accept</button>` : ''}
                ${notification.type === 'new_problem' && notification.communityId ? `<a href="/com/${notification.communityId}" class="btn btn-sm btn-outline">View</a>` : ''}
                ${notification.type === 'problem_solved' && notification.communityId ? `<a href="/com/${notification.communityId}" class="btn btn-sm btn-outline">Check Solution</a>` : ''}
              </div>
            </div>
          </div>
        `).join('');
      }
    }

    function getNotificationIcon(type) {
      const icons = {
        'new_problem': '<i class="fas fa-exclamation-circle text-warning"></i>',
        'problem_solved': '<i class="fas fa-check-circle text-success"></i>',
        'solution_confirmed': '<i class="fas fa-thumbs-up text-info"></i>',
        'invitation': '<i class="fas fa-user-plus text-primary"></i>',
        'new_member': '<i class="fas fa-users text-info"></i>',
        'general': '<i class="fas fa-bell text-gray"></i>'
      };
      return icons[type] || icons.general;
    }

    function formatTime(timestamp) {
      const now = new Date();
      const time = new Date(timestamp);
      const diff = now - time;
      
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);
      
      if (minutes < 1) return 'Just now';
      if (minutes < 60) return `${minutes}m ago`;
      if (hours < 24) return `${hours}h ago`;
      if (days < 7) return `${days}d ago`;
      
      return time.toLocaleDateString();
    }

    async function markNotificationRead(notificationId) {
      try {
        await fetch('/mark-notification-read', {
          method: 'POST',
          credentials: 'same-origin',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ notificationId })
        });
        await loadNotifications();
      } catch (error) {
        console.error('Failed to mark notification as read:', error);
      }
    }

    async function markAllNotificationsRead() {
      try {
        await fetch('/mark-all-notifications-read', {
          method: 'POST',
          credentials: 'same-origin',
          headers: {
            'Content-Type': 'application/json',
          }
        });
        await loadNotifications();
      } catch (error) {
        console.error('Failed to mark all notifications as read:', error);
      }
    }

    async function acceptInvitation(communityId) {
      try {
        const response = await fetch(`/accept-invitation/${communityId}`, { method: 'POST', credentials: 'same-origin' });
        if (response.ok) {
          await loadNotifications();
          window.location.href = `/com/${communityId}`;
        } else {
          alert('Failed to accept invitation');
        }
      } catch (error) {
        console.error('Failed to accept invitation:', error);
        alert('Failed to accept invitation');
      }
    }

    // Notification dropdown toggle
    document.getElementById('notificationBell').addEventListener('click', function(e) {
      e.stopPropagation();
      const dropdown = document.getElementById('notificationDropdown');
      dropdown.classList.toggle('active');
      if (dropdown.classList.contains('active')) {
        loadNotifications();
      }
    });

    document.getElementById('markAllRead').addEventListener('click', markAllNotificationsRead);

    // Close dropdown when clicking outside
    document.addEventListener('click', function() {
      document.getElementById('notificationDropdown').classList.remove('active');
    });

    // Auto-refresh notifications every 30 seconds
    setInterval(loadNotifications, 30000);

    // Load notifications on page load
    document.addEventListener('DOMContentLoaded', loadNotifications);
  script. 
    // Test audio function
    function testAudio(problemId) {
      console.log(`Testing audio for problem: ${problemId}`);
      
      // Test the endpoint
      fetch(`/problem-audio/${problemId}`)
        .then(response => {
          console.log('Response status:', response.status);
          console.log('Content-Type:', response.headers.get('Content-Type'));
          console.log('Content-Length:', response.headers.get('Content-Length'));
          
          if (response.ok) {
            return response.blob();
          } else {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
        })
        .then(blob => {
          console.log('Audio blob:', blob);
          console.log('Blob size:', blob.size, 'bytes');
          console.log('Blob type:', blob.type);
          
          if (blob.size === 0) {
            alert('Audio blob is empty!');
            return;
          }
          
          // Create a test player
          const audioUrl = URL.createObjectURL(blob);
          const testPlayer = new Audio();
          testPlayer.src = audioUrl;
          
          testPlayer.onloadeddata = () => {
            console.log('Audio loaded successfully!');
            console.log('Duration:', testPlayer.duration, 'seconds');
            alert(`Audio loaded successfully! Duration: ${testPlayer.duration.toFixed(2)} seconds, Size: ${blob.size} bytes`);
          };
          
          testPlayer.onerror = (e) => {
            console.error('Audio error:', e);
            alert('Error playing audio: ' + testPlayer.error.message);
          };
          
          testPlayer.load();
          
          // Clean up after 30 seconds
          setTimeout(() => {
            URL.revokeObjectURL(audioUrl);
          }, 30000);
        })
        .catch(error => {
          console.error('Error fetching audio:', error);
          alert('Error: ' + error.message);
        });
    }

    // Enhanced playAudio function
    function playAudio(problemId) {
      console.log(`Attempting to play audio for problem: ${problemId}`);
      
      const container = document.getElementById(`audioContainer-${problemId}`);
      const player = document.getElementById(`audioPlayer-${problemId}`);
      const playBtn = document.querySelector(`button[onclick="playAudio('${problemId}')"]`);
      const stopBtn = document.getElementById(`stopBtn-${problemId}`);
      
      // Show container
      container.style.display = 'block';
      
      // Set source if not already set
      if (!player.src || player.src === '') {
        player.src = `/problem-audio/${problemId}`;
        console.log('Set audio source to:', player.src);
      }
      
      // Clear any previous error
      player.onerror = null;
      
      // Set up error handler
      player.onerror = function(e) {
        console.error('Audio playback error:', e);
        console.error('Error details:', player.error);
        
        let errorMsg = 'Unknown error';
        switch(player.error.code) {
          case MediaError.MEDIA_ERR_ABORTED:
            errorMsg = 'Playback was aborted';
            break;
          case MediaError.MEDIA_ERR_NETWORK:
            errorMsg = 'Network error';
            break;
          case MediaError.MEDIA_ERR_DECODE:
            errorMsg = 'Decoding error - audio format not supported';
            break;
          case MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED:
            errorMsg = 'Audio format not supported';
            break;
        }
        
        alert(`Cannot play audio: ${errorMsg}`);
        
        // Reset button states
        if (playBtn) playBtn.style.display = 'inline-block';
        if (stopBtn) stopBtn.style.display = 'none';
      };
      
      // Set up loaded event
      player.onloadeddata = function() {
        console.log('Audio loaded, duration:', player.duration);
        if (player.duration === Infinity || player.duration === 0) {
          console.warn('Audio has invalid duration:', player.duration);
        }
      };
      
      // Set up ended event
      player.onended = function() {
        console.log('Audio ended');
        if (playBtn) playBtn.style.display = 'inline-block';
        if (stopBtn) stopBtn.style.display = 'none';
      };
      
      // Try to play
      player.play().then(() => {
        console.log('Audio playback started successfully');
        // Update button states
        if (playBtn) playBtn.style.display = 'none';
        if (stopBtn) stopBtn.style.display = 'inline-block';
      }).catch(error => {
        console.error('Play failed:', error);
        
        // Check if we need to load first
        if (error.name === 'NotSupportedError' || error.name === 'NotAllowedError') {
          // Try loading first, then playing
          player.load();
          setTimeout(() => {
            player.play().catch(e => {
              console.error('Retry also failed:', e);
              alert(`Cannot play audio: ${e.message}`);
            });
          }, 100);
        } else {
          alert(`Cannot play audio: ${error.message}`);
        }
      });
    }

    // Stop audio function
    function stopAudio(problemId) {
      const player = document.getElementById(`audioPlayer-${problemId}`);
      const playBtn = document.querySelector(`button[onclick="playAudio('${problemId}')"]`);
      const stopBtn = document.getElementById(`stopBtn-${problemId}`);
      
      if (player) {
        player.pause();
        player.currentTime = 0;
        
        // Update button states
        if (playBtn) playBtn.style.display = 'inline-block';
        if (stopBtn) stopBtn.style.display = 'none';
      }
    }
script.
  // Check for supported audio formats
  function getSupportedMimeType() {
    const types = [
      'audio/mpeg',          // MP3
      'audio/mp4',           // MP4/AAC
      'audio/webm',          // WebM
      'audio/ogg',           // OGG
      'audio/wav',           // WAV
      'audio/x-wav',         // WAV
      'audio/mp3'            // MP3 alternative
    ];
    
    for (let type of types) {
      if (MediaRecorder.isTypeSupported(type)) {
        console.log('Found supported MIME type:', type);
        return type;
      }
    }
    
    // If none are explicitly supported, try these common ones
    if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) {
      return 'audio/webm;codecs=opus';
    }
    
    if (MediaRecorder.isTypeSupported('audio/webm')) {
      return 'audio/webm';
    }
    
    // Default fallback - let browser choose
    return 'audio/webm';
  }

  let mediaRecorder;
  let audioChunks = [];
  let recordingStartTime;
  let timerInterval;
  let isRecording = false;
  let savedAudioBlob = null;
  let currentMimeType = 'audio/mpeg'; // Default to MP3

  // DOM Elements
  const startBtn = document.getElementById('startRecording');
  const stopBtn = document.getElementById('stopRecording');
  const cancelBtn = document.getElementById('cancelRecording');
  const recordingStatus = document.getElementById('recordingStatus');
  const recordingTimer = document.getElementById('recordingTimer');
  const audioPreview = document.getElementById('audioPreview');
  const recordingActions = document.getElementById('recordingActions');
  const saveBtn = document.getElementById('saveRecording');
  const discardBtn = document.getElementById('discardRecording');
  const audioDataInput = document.getElementById('audioData');
  const audioMimeTypeInput = document.getElementById('audioMimeType');
  const raiseProblemForm = document.getElementById('raiseProblemForm');

  // Initially hide recording status and actions
  recordingStatus.style.display = 'none';
  recordingActions.style.display = 'none';

  // Start Recording with supported format
  startBtn.addEventListener('click', async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ 
        audio: {
          echoCancellation: true,
          noiseSuppression: true,
          sampleRate: 44100 // Higher quality for MP3
        } 
      });
      
      // Get supported MIME type
      currentMimeType = getSupportedMimeType();
      console.log('Using MIME type:', currentMimeType);
      
      // Try to create MediaRecorder with the supported type
      let options = {};
      if (currentMimeType) {
        options.mimeType = currentMimeType;
      }
      
      mediaRecorder = new MediaRecorder(stream, options);
      
      audioChunks = [];
      
      mediaRecorder.ondataavailable = (event) => {
        if (event.data.size > 0) {
          audioChunks.push(event.data);
        }
      };
      
      mediaRecorder.onstop = () => {
        const audioBlob = new Blob(audioChunks, { 
          type: mediaRecorder.mimeType || currentMimeType
        });
        
        console.log('Audio recorded:', {
          size: audioBlob.size,
          type: audioBlob.type,
          duration: recordingStartTime ? ((Date.now() - recordingStartTime) / 1000).toFixed(2) + 's' : 'unknown'
        });
        
        const audioUrl = URL.createObjectURL(audioBlob);
        audioPreview.src = audioUrl;
        audioPreview.style.display = 'block';
        
        // Store the blob for potential saving
        savedAudioBlob = audioBlob;
        
        // Show recording actions
        recordingActions.style.display = 'flex';
        
        // Update UI
        stopBtn.style.display = 'none';
        cancelBtn.style.display = 'none';
        startBtn.style.display = 'block';
        recordingStatus.style.display = 'none';
        
        // Stop all tracks
        stream.getTracks().forEach(track => track.stop());
      };
      
      // Start recording
      mediaRecorder.start(100); // Collect data every 100ms
      isRecording = true;
      recordingStartTime = Date.now();
      
      // Start timer
      updateTimer();
      timerInterval = setInterval(updateTimer, 1000);
      
      // Update UI
      startBtn.style.display = 'none';
      stopBtn.style.display = 'inline-block';
      cancelBtn.style.display = 'inline-block';
      recordingStatus.style.display = 'flex';
      recordingActions.style.display = 'none';
      audioPreview.style.display = 'none';
      
    } catch (error) {
      console.error('Error accessing microphone:', error);
      
      // Try with simpler constraints
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        alert('Microphone access granted. Please try recording again.');
        stream.getTracks().forEach(track => track.stop());
      } catch (simpleError) {
        alert('Could not access microphone. Please check browser permissions and try again.');
      }
    }
  });

  // Save Recording - Convert to Base64
  saveBtn.addEventListener('click', async () => {
    if (!savedAudioBlob) return;
    
    try {
      // Convert blob to base64
      const base64Data = await blobToBase64(savedAudioBlob);
      
      // Store in hidden inputs
      audioDataInput.value = base64Data.split(',')[1]; // Remove data URL prefix
      audioMimeTypeInput.value = savedAudioBlob.type || currentMimeType;
      
      // Update UI to show recording is saved
      saveBtn.innerHTML = '<i class="fas fa-check"></i> Saved';
      saveBtn.classList.remove('btn-success');
      saveBtn.classList.add('btn-secondary');
      saveBtn.disabled = true;
      discardBtn.innerHTML = '<i class="fas fa-times"></i> Remove';
      
      console.log('Audio saved for submission:', {
        size: savedAudioBlob.size,
        type: savedAudioBlob.type,
        base64Length: base64Data.length
      });
    } catch (error) {
      console.error('Error saving audio:', error);
      alert('Error saving audio recording.');
    }
  });
  // Alternative: Encode as MP3 using lamejs
  function encodeToMp3(audioBuffer) {
    const mp3encoder = new lamejs.Mp3Encoder(1, 44100, 128); // mono, 44.1kHz, 128kbps
    const samples = audioBuffer.getChannelData(0);
    const mp3Data = [];
    
    const sampleBlockSize = 1152;
    for (let i = 0; i < samples.length; i += sampleBlockSize) {
      const sampleChunk = samples.subarray(i, i + sampleBlockSize);
      const mp3buf = mp3encoder.encodeBuffer(sampleChunk);
      if (mp3buf.length > 0) {
        mp3Data.push(mp3buf);
      }
    }
    
    const mp3buf = mp3encoder.flush();
    if (mp3buf.length > 0) {
      mp3Data.push(mp3buf);
    }
    
    return new Blob(mp3Data, { type: 'audio/mpeg' });
  }